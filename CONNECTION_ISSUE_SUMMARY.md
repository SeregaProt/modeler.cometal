# Проблема со связями - Анализ и решение

## Проблема
Связи между процессами пропадают и не сохраняются при перезагрузке страницы.

## Причины проблемы

### 1. Порядок определения функций
- `handleStartConnection` использует `createConnection`, но определена раньше
- Это создает проблему с зависимостями в React useCallback

### 2. Сложная логика MiroConnectionManager
- Использование внешнего менеджера усложняет отладку
- Проблемы с поиском целевых узлов в DOM

### 3. Проблемы с состоянием
- Состояние связей может не синхронизироваться с API
- Возможные race conditions при создании связей

## Решение

### Упрощенная логика создания связей:

```javascript
// 1. Функция создания связи (определяется первой)
const createConnection = useCallback(async (sourceNodeId, targetNodeId) => {
  // Проверка существующих связей
  // Создание через API
  // Обновление локального состояния
}, [edges, projectId, selectedRelationType]);

// 2. Обработчик начала создания связи
const handleStartConnection = useCallback((sourceNodeId, sourceHandleId) => {
  if (isConnecting) {
    // Завершаем создание связи
    if (connectionSource && connectionSource.nodeId !== sourceNodeId) {
      createConnection(connectionSource.nodeId, sourceNodeId);
    }
    setIsConnecting(false);
    setConnectionSource(null);
  } else {
    // Начинаем создание связи
    setIsConnecting(true);
    setConnectionSource({ nodeId: sourceNodeId, handleId: sourceHandleId });
  }
}, [isConnecting, connectionSource, createConnection]);
```

### Логика работы:
1. **Клик на синюю точку первого процесса** → начало создания связи
2. **Клик на синюю точку второго процесса** → завершение создания связи
3. **Сохранение в API** → обновление локаль��ого состояния
4. **Отображение на карте** → связь видна и сохраняется

## Текущее состояние
- ✅ Исправлен порядок функций
- ✅ Упрощена логика создания связей
- ✅ Добавлено подробное логирование
- ⏳ Требуется тестирование

## Следующие шаги
1. Протестировать создание связей
2. Проверить сохранение при перезагрузке
3. При необходимости добавить дополнительную отладку

## Инструкции для пользователя
1. Кликните на процесс для выделения (появятся синие точки)
2. Кликните на синюю точку первого процесса
3. Кликните на синюю точку второго процесса
4. Связь должна создаться и сохраниться